#!/bin/bash

set -e

# Check if running as root
if [ "$EUID" -eq 0 ]; then
    echo "âŒ Please don't run this script as root. Use sudo only where needed."
    exit 1
fi

echo "ðŸ”„ Starting system updates..."
echo "â° Started at $(date)"

if [ -f /etc/arch-release ]; then
    # For Arch-based systems
    echo "ðŸ“¦ Updating Arch packages..."
    sudo pacman -Syu --noconfirm

    if command -v paru &> /dev/null; then
        echo "ðŸ“¦ Updating AUR packages..."
        paru -Sua --noconfirm
    elif command -v yay &> /dev/null; then
        echo "ðŸ“¦ Updating AUR packages with yay..."
        yay -Sua --noconfirm
    fi

    # Remove orphan packages only if they exist
    orphans=$(pacman -Qdtq 2>/dev/null || true)
    if [ -n "$orphans" ]; then
        echo "ðŸ—‘ï¸  Removing orphan packages..."
        echo "$orphans" | xargs sudo pacman -Rns --noconfirm
    fi

    echo "ðŸ§¹ Cleaning package cache..."
    sudo pacman -Scc --noconfirm
else
    # For Ubuntu/Pop!_OS-based systems
    echo "ðŸ“¦ Updating Ubuntu/Debian packages..."
    sudo apt update
    sudo apt upgrade -y --allow-downgrades
    sudo apt autopurge -y && sudo apt autoremove -y && sudo apt clean

    if command -v pacstall &> /dev/null; then
        echo "ðŸ“¦ Updating Pacstall..."
        pacstall -U --disable-prompts # Update pacstall tool itself
        pacstall -Up --disable-prompts # Update all installed pacstall packages
    fi
fi

# Update Flatpak
if command -v flatpak &> /dev/null; then
    echo "ðŸ“¦ Updating Flatpak packages..."
    flatpak update -y
fi

# Update Snap
if command -v snap &> /dev/null; then
    echo "ðŸ“¦ Updating Snap packages..."
    sudo snap refresh
fi

# Update Composer
if command -v composer &> /dev/null; then
    echo "ðŸŽ¼ Updating Composer..."
    composer global self-update --quiet
    composer global update --no-progress --profile
fi

# Update npm global packages
if command -v npm &> /dev/null; then
    echo "ðŸ“¦ Updating npm global packages..."
    npm update -g --silent
fi

# Update pnpm
if command -v pnpm &> /dev/null; then
    echo "ðŸ“¦ Updating pnpm..."
    pnpm self-update
    pnpm update -g
fi

# Update uv
if command -v uv &> /dev/null; then
    echo "ðŸ Updating uv..."
    timeout 120 uv self update --quiet || echo "âš ï¸  UV update timed out or failed, skipping..."

    echo "ðŸ”§ Updating uv tools..."
    uv tool upgrade --all --quiet
fi

echo ""
echo "âœ… All updates completed!"
echo ""
echo "ðŸ“Š Summary:"
if command -v paru &> /dev/null; then
    echo "  â€¢ Used paru for AUR packages"
elif command -v yay &> /dev/null; then
    echo "  â€¢ Used yay for AUR packages (fallback)"
fi
echo "  â€¢ Package cache cleaned"
echo "  â€¢ Orphaned packages removed"
