#!/bin/bash

set -e

echo "ğŸ”„ Starting system updates..."

if [ -f /etc/arch-release ]; then
    # For Arch-based systems
    echo "ğŸ“¦ Updating Arch packages..."
    sudo pacman -Syu --noconfirm

    if command -v yay &> /dev/null; then
        echo "ğŸ“¦ Updating AUR packages..."
        yay -Sua --noconfirm
    fi

    # Remove orphan packages only if they exist
    orphans=$(pacman -Qdtq)
    if [ -n "$orphans" ]; then
        echo "ğŸ—‘ï¸  Removing orphan packages..."
        sudo pacman -Rns --noconfirm $orphans
    fi

    echo "ğŸ§¹ Cleaning package cache..."
    sudo pacman -Sc --noconfirm
else
    # For Ubuntu/Pop!_OS-based systems
    echo "ğŸ“¦ Updating Ubuntu/Debian packages..."
    sudo apt update
    sudo apt upgrade -y --allow-downgrades
    sudo apt autopurge -y && sudo apt autoremove -y && sudo apt clean

    if command -v pacstall &> /dev/null; then
        echo "ğŸ“¦ Updating Pacstall..."
        pacstall -U --disable-prompts # Update pacstall tool itself
        pacstall -Up --disable-prompts # Update all installed pacstall packages
    fi
fi

# Update Flatpak
if command -v flatpak &> /dev/null; then
    echo "ğŸ“¦ Updating Flatpak packages..."
    flatpak update -y
fi

# Update Snap
if command -v snap &> /dev/null; then
    echo "ğŸ“¦ Updating Snap packages..."
    sudo snap refresh
fi

# Update Composer
if command -v composer &> /dev/null; then
    echo "ğŸ¼ Updating Composer..."
    sudo composer global self-update
    composer global update -vv --profile
fi

# Update npm global packages
if command -v npm &> /dev/null; then
    echo "ğŸ“¦ Updating npm global packages..."
    sudo npm update -g
fi

# Update pnpm
if command -v pnpm &> /dev/null; then
    echo "ğŸ“¦ Updating pnpm..."
    pnpm self-update
    pnpm update -g
fi

# Update uv
if command -v uv &> /dev/null; then
    echo "ğŸ Updating uv..."
    timeout 120 uv self update || echo "âš ï¸  UV update timed out or failed, skipping..."

    echo "ğŸ”§ Updating uv tools..."
    uv tool upgrade --all
fi

echo "âœ… All updates completed!"
