#!/usr/bin/env bash
set -euo pipefail

# Check for required commands
if ! command -v fzf >/dev/null 2>&1; then
  echo "Error: fzf is required but not installed." >&2
  exit 1
fi

if ! command -v tmux >/dev/null 2>&1; then
  echo "Error: tmux is required but not installed." >&2
  exit 1
fi

# List windows (across all sessions, excluding popup-like sessions)
list() {
  local exclude_pattern="${TMUX_PICK_EXCLUDE:-^(popup|scratch|temp)$}"

  # Windows with activity timestamp
  tmux list-windows -a -F $'W\t#{session_name}\t#{window_index}\t\t#{window_activity}\t#{session_name}:#{window_index} #{window_name}' 2>/dev/null | \
    grep -Ev $'\t'"$exclude_pattern"$'\t' || true
}

# Sort by activity (field 5)
list_sorted() {
  list | sort -t$'\t' -k5 -rn 2>/dev/null || list
}

# Show labels (field 6+) but keep raw row for parsing
sel="$(list_sorted | fzf \
  -e \
  -d $'\t' \
  --with-nth=6.. \
  --prompt='â¯ ' \
  --reverse \
  || true)"

[ -z "${sel:-}" ] && exit 0

# Parse selection using awk for safer field extraction
sess=$(echo "$sel" | awk -F'\t' '{print $2}')
win=$(echo "$sel" | awk -F'\t' '{print $3}')

# Validate target exists before switching
if tmux list-windows -t "$sess" -F '#{window_index}' 2>/dev/null | grep -q "^${win}$"; then
  exec tmux switch-client -t "$sess:$win"
else
  echo "Error: Window '$sess:$win' not found" >&2
  exit 1
fi
